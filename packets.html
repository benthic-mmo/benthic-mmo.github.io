---
layout: default
title: Packets
---

<div class="bubble">
  <h1>UDP Packet handling</h1>
  Once the session is established after a login, the server will being sending
  messages to the Core over UDP. These packets are received using the process
  that we started when establishing the
  <a href="/login#4">session</a> after a successful login.
  <hr />
  <div class="center">
    <div class="bubble-column" style="max-width: 700px">
      <div class="bubble contrast small">
        <h1>1.</h1>
        <p>
          Raw UDP packets enter the Core from
          <a
            href="https://docs.rs/metaverse_core/latest/metaverse_core/session/struct.Mailbox.html#method.start_udp_read"
          >
            start_udp_read()</a
          >. It continuously receives messages from the server as they come into
          the socket.
        </p>
      </div>
      <div class="bubble contrast small">
        <h1>2.</h1>
        <p>
          The raw data is then converted to a
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/packet/struct.Packet.html"
            >Packet</a
          >
          object using the packet's
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/packet/struct.Packet.html#method.from_bytes"
            >from_bytes</a
          >
          function.
        </p>
      </div>
      <div class="bubble contrast small">
        <h1>3.</h1>
        <p>
          The packet's from_bytes functon
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7586490c87ca4e001d811be20673fc9b00e2a550/crates/messages/src/packet/packet.rs#L36"
            >then</a
          >
          tries to parse the
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/header/index.html"
            >Header</a
          >, which contains the information about what type of packet the
          following data will be.
        </p>
      </div>
      <div class="bubble contrast small">
        <h1>4.</h1>
        <p>
          Handle edgecases like if the packet has no body, or if the packet
          header tells you the packet body is
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7586490c87ca4e001d811be20673fc9b00e2a550/crates/messages/src/packet/packet.rs#L64"
            >zerocoded</a
          >.
        </p>
      </div>
      <div class="bubble contrast small">
        <h1>5.</h1>
        <p>
          The combination of the header's
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/header/enum.PacketFrequency.html"
            >frequency</a
          >
          and ID determine the
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/packet_types/enum.PacketType.html"
            >Type</a
          >
          of the packet. Using the
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/packet_types/enum.PacketType.html#method.from_id"
            >from_id()</a
          >
          function, the packet's body is parsed and returned.
        </p>
      </div>
    </div>
  </div>
</div>

<div class="bubble">
  <h1>Reliable Packets</h1>
  Some packets have a "reliable" flag. This means that on receive, the client
  needs to respond with an
  <a
    href="https://docs.rs/metaverse_messages/latest/metaverse_messages/udp/core/packet_ack/index.html"
    >ack packet</a
  >, or else the server will continue sending it.
  <br />
  When a reliable packet is received, the core will immediately
  <a
    href="https://github.com/benthic-mmo/metaverse_client/blob/7586490c87ca4e001d811be20673fc9b00e2a550/crates/core/src/transport/udp_handler.rs#L34"
    >add the packet's sequence number</a
  >
  to the ack list. The mailbox is then triggered to
  <a
    href="https://docs.rs/metaverse_core/latest/metaverse_core/session/struct.Mailbox.html#impl-Handler%3CSendAckList%3E-for-Mailbox"
    >send the list</a
  >.
</div>
