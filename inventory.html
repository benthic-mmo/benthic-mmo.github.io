---
layout: default
title: Inventory
---

{% include happy_benthic.html %}
<div class="bubble">
  <h1>Inventory</h1>
  The inventory is a core part of metaverse servers. This manages the objects
  your user owns and can spawn in the world.
  <br />
  <br>
  <div class="bubble contrast small">
    <p>
      Implementing inventory requires using the
      <a href="https://docs.rs/metaverse_messages/latest/metaverse_messages/http/capabilities/enum.Capability.html#variant.FetchInventoryDescendents2">FetchInventoryDescendents2</a>
      endpoint. If you are unfamiliar with how capabilities work, visit
      <a href="/capabilities">the capabilities</a> page on these docs.
    </p>
  </div>
  <div class="center">
    <div class="bubble-column" style="max-width: 700px;">
      <div class="bubble contrast small">
        <h2>1.</h2>
        <p>
          Initial Inventory information comes in with the
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/http/login/login_response/struct.LoginResponse.html#structfield.inventory_root"
            >LoginResponse</a
          >, and is stored globally in the session.
        </p>
      </div>
      <div class="bubble contrast small">
        <h2>2.</h2>
        <p>
          The initialization function
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7586490c87ca4e001d811be20673fc9b00e2a550/crates/core/src/session.rs#L449"
            >triggers</a
          >
          a
          <a
            href="https://docs.rs/metaverse_core/latest/metaverse_core/session/struct.Mailbox.html#impl-Handler%3CRefreshInventoryEvent%3E-for-Mailbox"
            >RefreshInventoryEvent</a
          >
          for the user's AgentID which is also returned from the LoginResponse.
          The initial request is a request for the user's inventory.
        </p>
      </div>
      <div class="bubble contrast small">
        <h2>3.</h2>
        <p>
          The RefreshInventoryEvent
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7586490c87ca4e001d811be20673fc9b00e2a550/crates/core/src/inventory.rs#L50"
            >waits</a
          >
          until the capability URL has returned from the initial capability
          request.
        </p>
      </div>
      <div class="bubble contrast small">
        <h2>4.</h2>
        <p>
          Make a request to the capability endpoint, using the sesion's
          inventory_root to make a
          <a
            href="https://docs.rs/metaverse_inventory/latest/metaverse_inventory/inventory_root/struct.FolderRequest.html"
            >FolderRequest</a
          >, to make a request to
          <a
            href="https://docs.rs/metaverse_inventory/latest/metaverse_inventory/inventory_root/fn.refresh_inventory.html"
            >refresh the user's inventory</a
          >.
        </p>
      </div>
      <div class="bubble contrast small">
        <h2>5.</h2>
        <p>
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/inventory/src/inventory_root.rs#L86"
            >Establish_inventory_dirs()</a
          >
          creates folders on disk to represent the user's inventory structure, and handles the item metadata.
          It then recursively calls
          <a
            href="https://docs.rs/metaverse_inventory/latest/metaverse_inventory/inventory_root/fn.refresh_inventory.html"
            >refresh_inventory()</a
          >
          on each of the subdirectories, creating more FolderRequests to the
          capability endpoint. 
        </p>
      </div>
    </div>
  </div>
</div>

<div class="bubble">
  <h1>Item Metadata</h1>
  The
  <a
    href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/inventory/src/inventory_root.rs#L86"
    >establish_inventory_dirs()</a
  >
  function reads the folder data and generates the objects received from the endpoint
  <a
    href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/inventory/src/inventory_root.rs#L93"
    >here</a
  >.
  <br />
  <br />
  The
  <a
    href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/messages/src/capabilities/folder_types.rs#L92"
    >Folder::from_llsd()</a
  >
  function prarses the LLSD-XML and retreives the
  <a
    href="https://docs.rs/metaverse_messages/latest/metaverse_messages/utils/item_metadata/struct.ItemMetadata.html"
    >item metadata</a
  >
  from the LLSD. This contains a minimal amount of information about the item
  object, such as the permissions, name, asset ID, description and type. These
  fields can be used to retreive the full item's data from the server using a
  different endpoint, and are saved to the session under the Folder object.
  <hr />
  At this point, the inventory's directory structure is populated, and contains
  the user's inventory objects. The folders are stored on-disk in a sqlite DB, which can be searched quickly without having to waste RAM on the folder structure.  
</div>

<div class="bubble">
  <h1>Folder Requests</h1>
  The user's folders are requested from the <a href="https://docs.rs/metaverse_messages/latest/metaverse_messages/http/capabilities/enum.Capability.html#variant.FetchInventoryDescendents2">FetchInventoryDescendents2</a> endpoint,
  whereas other user's folders are requested from the <a href="https://docs.rs/metaverse_messages/latest/metaverse_messages/http/capabilities/enum.Capability.html#variant.FetchLibDescendents2">FetchLibDescendents2</a>
  endpoint (for things like rendering other players' models).
  <br />
  The XML for the request is structured like so

  <div class="bubble sinister">
    <table>
      <tr>
        <td>Folder</td>
        <td>
          <table>
            <tr>
              <td>fetch_folders</td>
              <td>boolean</td>
            </tr>
            <tr>
              <td>fetch_items</td>
              <td>boolean</td>
            </tr>
            <tr>
              <td>folder_id</td>
              <td>uuid</td>
            </tr>
            <tr>
              <td>sort_order</td>
              <td>integer</td>
            </tr>
            <tr>
              <td>owner_id</td>
              <td>uuid</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </div>
  For example, a request would look like this.
  <pre><code class="language-xml">Post: http://172.20.20.20:9000/371320f6-7694-4e9c-bbb9-19e56f1e1027
Header: "Content-Type", "application/llsd+xml
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;llsd&gt;
  &lt;map&gt;
    &lt;key&gt;folders&lt;/key&gt;
    &lt;array&gt;
      &lt;map&gt;
        &lt;key&gt;fetch_folders&lt;/key&gt;
        &lt;boolean&gt;true&lt;/boolean&gt;
        &lt;key&gt;fetch_items&lt;/key&gt;
        &lt;boolean&gt;true&lt;/boolean&gt;
        &lt;key&gt;folder_id&lt;/key&gt;
        &lt;uuid&gt;5b70e16b-4e8c-e463-f9b5-16e28f1b7213&lt;/uuid&gt;
        &lt;key&gt;sort_order&lt;/key&gt;
        &lt;integer&gt;0&lt;/integer&gt;
        &lt;key&gt;owner_id&lt;/key&gt;
        &lt;uuid&gt;fb2e5541-66ba-4019-a5de-e8b9286b0914&lt;/uuid&gt;
      &lt;/map&gt;
    &lt;/array&gt;
  &lt;/map&gt;
&lt;/llsd&gt;
</code></pre>
</div>
