---
layout: default
title: Packets
---

<div class="bubble">
  <h1>UDP Packet handling</h1>
  Once the session is established after a login, the server will being sending
  messages to the Core over UDP. These are handled by the server to client
  process that we started in the <a href="/login#4">previous chapter</a>.
  <hr />
  <div class="extra_sinister_bubble">
    <div class="bubble-column" style="max-width: 700px">
      <div class="contrast_bubble_small">
        <h1>1.</h1>
        <p>
          Raw UDP packets enter the Core from
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/core/src/udp_handler.rs#L27"
          >
            here </a
          >. It continuously receives messages from the server as they come into
          the socket.
        </p>
      </div>
      <div class="contrast_bubble_small">
        <h1>2.</h1>
        <p>
          The raw data is then converted to a
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/packet/index.html"
            >Packet</a
          >
          object using the packet's
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/packet/struct.Packet.html#method.from_bytes"
            >from_bytes</a
          >
          function.
        </p>
      </div>
      <div class="contrast_bubble_small">
        <h1>3.</h1>
        <p>
          The packet's from_bytes functon
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/messages/src/packet/packet.rs#L36"
            >then</a
          >
          tries to parse the
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/header/index.html"
            >Header</a
          >, which contains the information about what type of packet the
          following data will be.
        </p>
      </div>
      <div class="contrast_bubble_small">
        <h1>4.</h1>
        <p>
          Handle edgecases like if the packet has no body, or if the packet
          header tells you the packet body is
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/messages/src/packet/packet.rs#L78"
            >zerocoded</a
          >.
        </p>
      </div>
      <div class="contrast_bubble_small">
        <h1>5.</h1>
        <p>
          The combination of the header's
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/header/enum.PacketFrequency.html"
            >frequency</a
          >
          and ID determine the
          <a
            href="https://docs.rs/metaverse_messages/latest/metaverse_messages/packet/packet_types/enum.PacketType.html"
            >Type</a
          >
          of the packet. Using the
          <a
            href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/messages/src/packet/packet_types.rs#L126"
            >from_id()</a
          >
          function, the packet's body is parsed and returned.
        </p>
      </div>
    </div>
  </div>
</div>

<div class="bubble">
  <h1>Reliable Packets</h1>
  Some packets have a "reliable" flag. This means that on receive, the client
  needs to respond with an
  <a
    href="https://docs.rs/metaverse_messages/latest/metaverse_messages/core/packet_ack/index.html"
    >ack packet</a
  >, or else the server will continue sending it.
  <br />
  When a reliable packet is received, the core will immediately add the packet's
  sequence number to the packet ID that needs to be acked, and then queue a
  PacketAck packet. This will be handled
  <a
    href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/core/src/udp_handler.rs#L51"
    >here</a
  >.

  <hr />
  The client can also send reliable packets to the server, which gets a little
  more tricky. The client
  <a
    href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/core/src/core/session.rs#L337"
    >creates a future</a
  >, which it then converts into an actor.
  <a
    href="https://github.com/benthic-mmo/metaverse_client/blob/7dff92943d2660b118346c77fddcd70b6b436631/crates/core/src/core/session.rs#L370"
    >send_ack</a
  >
  runs in the background, waiting until either the maximum number of attempts
  have run out, or the client receives the ack it's waiting for on its UDP port.
</div>
